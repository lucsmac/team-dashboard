# üê≥ Docker Setup - Team Report Dashboard

Documenta√ß√£o completa para executar o projeto usando Docker e Docker Compose.

## üìã √çndice

- [Pr√©-requisitos](#pr√©-requisitos)
- [Arquitetura](#arquitetura)
- [Quick Start](#quick-start)
- [Ambientes](#ambientes)
- [Configura√ß√£o](#configura√ß√£o)
- [Comandos √öteis](#comandos-√∫teis)
- [Troubleshooting](#troubleshooting)
- [Arquivos Docker](#arquivos-docker)

## üîß Pr√©-requisitos

- **Docker** 20.10+ ([Instalar Docker](https://docs.docker.com/get-docker/))
- **Docker Compose** 2.0+ ([Instalar Docker Compose](https://docs.docker.com/compose/install/))

### Verificar Instala√ß√µes

```bash
docker --version
# Docker version 20.10.0 ou superior

docker-compose --version
# Docker Compose version 2.0.0 ou superior
```

## üèóÔ∏è Arquitetura

O projeto √© dividido em **3 containers Docker**:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          Docker Compose                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   Frontend   ‚îÇ   ‚îÇ    Backend    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   (React)    ‚îÇ‚óÑ‚îÄ‚îÄ‚î§   (Express)   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   Nginx:80   ‚îÇ   ‚îÇ   Port:5000   ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                             ‚îÇ           ‚îÇ
‚îÇ                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ                     ‚îÇ   PostgreSQL   ‚îÇ  ‚îÇ
‚îÇ                     ‚îÇ   Port:5432    ‚îÇ  ‚îÇ
‚îÇ                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Containers

1. **postgres** - PostgreSQL 14 Alpine
   - Banco de dados principal
   - Volume persistente: `postgres_data`
   - Porta: 5432

2. **backend** - Node.js 18 Alpine + Express
   - API REST
   - Prisma ORM
   - Auto migrations + seed
   - Porta: 5000

3. **frontend** - Node.js 18 Alpine + Nginx
   - React + Vite (build)
   - Nginx para servir arquivos est√°ticos
   - Porta: 80 (produ√ß√£o) ou 5173 (dev)

## üöÄ Quick Start

### Produ√ß√£o (Build Otimizado)

```bash
# 1. Copiar arquivo de ambiente
cp .env.docker .env

# 2. (Opcional) Editar vari√°veis no .env
nano .env

# 3. Subir todos os containers
docker-compose up -d

# 4. Verificar logs
docker-compose logs -f

# 5. Acessar aplica√ß√£o
# Frontend: http://localhost:3000
# Backend: http://localhost:5000
# Postgres: localhost:5432
```

### Desenvolvimento (Hot Reload)

```bash
# 1. Copiar arquivo de ambiente
cp .env.docker .env

# 2. Subir em modo desenvolvimento
docker-compose -f docker-compose.dev.yml up -d

# 3. Verificar logs
docker-compose -f docker-compose.dev.yml logs -f

# 4. Acessar aplica√ß√£o
# Frontend: http://localhost:5173 (Vite dev server)
# Backend: http://localhost:5000
```

## üåç Ambientes

### üì¶ Produ√ß√£o (`docker-compose.yml`)

**Caracter√≠sticas:**
- Build multi-stage otimizado
- Frontend servido via Nginx
- Backend em modo produ√ß√£o
- Imagens menores e mais eficientes
- Sem volumes de c√≥digo (apenas node_modules)

**Uso:**
```bash
docker-compose up -d                 # Iniciar
docker-compose down                  # Parar
docker-compose logs -f               # Ver logs
docker-compose ps                    # Status dos containers
```

### üî® Desenvolvimento (`docker-compose.dev.yml`)

**Caracter√≠sticas:**
- Hot reload habilitado (frontend e backend)
- Volumes montados para c√≥digo-fonte
- Nodemon no backend
- Vite dev server no frontend
- Prisma Studio dispon√≠vel

**Uso:**
```bash
docker-compose -f docker-compose.dev.yml up -d
docker-compose -f docker-compose.dev.yml down
docker-compose -f docker-compose.dev.yml logs -f backend
docker-compose -f docker-compose.dev.yml restart frontend
```

## ‚öôÔ∏è Configura√ß√£o

### Arquivo `.env`

Crie um arquivo `.env` na raiz do projeto:

```env
# PostgreSQL
POSTGRES_USER=teamreport
POSTGRES_PASSWORD=teamreport123
POSTGRES_DB=team_report
POSTGRES_PORT=5432

# Backend
BACKEND_PORT=5000
NODE_ENV=production

# Frontend
FRONTEND_PORT=3000
VITE_API_URL=http://localhost:5000/api
```

### Personalizar Portas

Para mudar as portas expostas, edite o `.env`:

```env
POSTGRES_PORT=15432    # PostgreSQL em porta diferente
BACKEND_PORT=8080      # Backend em porta 8080
FRONTEND_PORT=8000     # Frontend em porta 8000
```

Depois recrie os containers:

```bash
docker-compose down
docker-compose up -d
```

### Vari√°veis de Ambiente Importantes

| Vari√°vel | Descri√ß√£o | Padr√£o |
|----------|-----------|--------|
| `POSTGRES_USER` | Usu√°rio do PostgreSQL | `teamreport` |
| `POSTGRES_PASSWORD` | Senha do PostgreSQL | `teamreport123` |
| `POSTGRES_DB` | Nome do banco | `team_report` |
| `BACKEND_PORT` | Porta da API | `5000` |
| `FRONTEND_PORT` | Porta do frontend | `3000` (prod) / `5173` (dev) |
| `NODE_ENV` | Ambiente Node | `production` / `development` |
| `VITE_API_URL` | URL da API para frontend | `http://localhost:5000/api` |

## üõ†Ô∏è Comandos √öteis

### Gerenciar Containers

```bash
# Iniciar todos os servi√ßos
docker-compose up -d

# Parar todos os servi√ßos
docker-compose down

# Parar e remover volumes (CUIDADO: apaga dados!)
docker-compose down -v

# Ver logs de todos os servi√ßos
docker-compose logs -f

# Ver logs de um servi√ßo espec√≠fico
docker-compose logs -f backend
docker-compose logs -f frontend
docker-compose logs -f postgres

# Reiniciar um servi√ßo espec√≠fico
docker-compose restart backend

# Verificar status
docker-compose ps

# Executar comando em container rodando
docker-compose exec backend sh
docker-compose exec postgres psql -U teamreport -d team_report
```

### Build e Rebuild

```bash
# Rebuild de todos os servi√ßos
docker-compose build

# Rebuild for√ßado (sem cache)
docker-compose build --no-cache

# Rebuild de um servi√ßo espec√≠fico
docker-compose build backend

# Rebuild e restart
docker-compose up -d --build
```

### Database Operations

```bash
# Acessar PostgreSQL
docker-compose exec postgres psql -U teamreport -d team_report

# Executar migrations manualmente
docker-compose exec backend npx prisma migrate deploy

# Rodar seed manualmente
docker-compose exec backend npm run seed

# Abrir Prisma Studio
docker-compose exec backend npx prisma studio
# Acesse: http://localhost:5555

# Backup do banco
docker-compose exec postgres pg_dump -U teamreport team_report > backup.sql

# Restaurar banco
cat backup.sql | docker-compose exec -T postgres psql -U teamreport -d team_report
```

### Monitoramento

```bash
# Ver uso de recursos
docker stats

# Ver containers em execu√ß√£o
docker ps

# Inspecionar container
docker inspect team-report-backend

# Ver logs em tempo real
docker-compose logs -f --tail=100
```

### Limpeza

```bash
# Remover containers parados
docker-compose down

# Remover containers, redes e volumes
docker-compose down -v

# Limpar tudo do Docker (CUIDADO!)
docker system prune -a

# Limpar apenas volumes n√£o usados
docker volume prune

# Limpar apenas imagens n√£o usadas
docker image prune -a
```

## üêõ Troubleshooting

### Container n√£o inicia

```bash
# Ver logs detalhados
docker-compose logs backend
docker-compose logs frontend
docker-compose logs postgres

# Verificar se portas est√£o em uso
lsof -ti:5000    # Backend
lsof -ti:3000    # Frontend
lsof -ti:5432    # PostgreSQL

# Rebuild for√ßado
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

### Erro "Port already in use"

```bash
# Matar processo na porta
lsof -ti:5000 | xargs kill -9

# Ou mudar porta no .env
BACKEND_PORT=8080
```

### Migrations n√£o aplicadas

```bash
# Executar migrations manualmente
docker-compose exec backend npx prisma migrate deploy

# Regenerar Prisma Client
docker-compose exec backend npx prisma generate
```

### Dados n√£o persistem

Verifique se o volume foi criado:

```bash
docker volume ls | grep team-report

# Se n√£o existir, crie manualmente
docker volume create team-report_postgres_data
```

### Frontend n√£o conecta no backend

1. Verifique `VITE_API_URL` no `.env`
2. Verifique se backend est√° rodando:
   ```bash
   curl http://localhost:5000/api/dashboard
   ```
3. Verifique logs do backend:
   ```bash
   docker-compose logs backend
   ```

### Permiss√µes no PostgreSQL

```bash
# Entrar no container
docker-compose exec postgres sh

# Verificar permiss√µes
psql -U teamreport -d team_report -c "\du"

# Conceder permiss√µes
psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE team_report TO teamreport;"
```

### Hot Reload n√£o funciona (Dev Mode)

Verifique se os volumes est√£o montados:

```bash
docker-compose -f docker-compose.dev.yml config

# Deve mostrar volumes como:
# volumes:
#   - ./backend:/app
#   - /app/node_modules
```

### Erro Prisma "Could not locate Query Engine" (Alpine Linux)

**Sintoma:**
```
PrismaClientInitializationError: Prisma Client could not locate the Query Engine for runtime "linux-musl-openssl-3.0.x"
```

**Causa:**
Docker usa Alpine Linux (musl libc), mas Prisma Client foi gerado para Debian/Ubuntu (glibc).

**Solu√ß√£o:**

1. **Adicionar binaryTargets ao schema.prisma** (j√° corrigido):
   ```prisma
   generator client {
     provider      = "prisma-client-js"
     binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
   }
   ```

2. **Regenerar Prisma Client localmente:**
   ```bash
   cd backend
   npx prisma generate
   ```

3. **Rebuild containers Docker:**
   ```bash
   docker-compose down
   docker-compose build --no-cache backend
   docker-compose up -d
   ```

**Para desenvolvimento:**
```bash
docker-compose -f docker-compose.dev.yml down
docker-compose -f docker-compose.dev.yml build --no-cache backend
docker-compose -f docker-compose.dev.yml up -d
```

**Nota:** Os Dockerfiles j√° foram ajustados para copiar o schema.prisma antes de gerar o Prisma Client, garantindo os bin√°rios corretos.

## üìÅ Arquivos Docker

### `docker-compose.yml`
Configura√ß√£o de produ√ß√£o com 3 servi√ßos:
- PostgreSQL com healthcheck
- Backend com migrations autom√°ticas
- Frontend com Nginx

### `docker-compose.dev.yml`
Configura√ß√£o de desenvolvimento com:
- Volumes montados para hot reload
- Nodemon no backend
- Vite dev server no frontend

### `Dockerfile` (frontend)
Multi-stage build:
- Stage 1: Build da aplica√ß√£o React
- Stage 2: Nginx servindo arquivos est√°ticos

### `Dockerfile.dev` (frontend)
Imagem para desenvolvimento com Vite dev server

### `backend/Dockerfile`
Imagem de produ√ß√£o:
- Node 18 Alpine
- Apenas depend√™ncias de produ√ß√£o
- Prisma Client gerado

### `backend/Dockerfile.dev`
Imagem para desenvolvimento:
- Todas as depend√™ncias
- Nodemon para hot reload

### `nginx.conf`
Configura√ß√£o do Nginx:
- Suporte a React Router
- Gzip compression
- Cache de assets est√°ticos
- Security headers

### `.dockerignore`
Arquivos ignorados no build:
- node_modules
- .env
- .git
- logs
- documenta√ß√£o

## üîê Seguran√ßa

### Produ√ß√£o

**IMPORTANTE**: Em produ√ß√£o, sempre:

1. **Mude as senhas padr√£o**:
   ```env
   POSTGRES_PASSWORD=senhaForteAqui123!@#
   ```

2. **Use secrets do Docker**:
   ```yaml
   secrets:
     db_password:
       file: ./secrets/db_password.txt
   ```

3. **N√£o exponha portas desnecess√°rias**:
   ```yaml
   # Remova o mapeamento de porta do PostgreSQL
   # ports:
   #   - "5432:5432"
   ```

4. **Use vari√°veis de ambiente seguras**:
   ```bash
   # N√£o commite o .env
   echo ".env" >> .gitignore
   ```

## üöÄ Deploy

### Deploy em servidor

```bash
# 1. Clonar reposit√≥rio no servidor
git clone <repo-url>
cd team-report

# 2. Configurar vari√°veis
cp .env.docker .env
nano .env

# 3. Subir containers
docker-compose up -d

# 4. Verificar logs
docker-compose logs -f

# 5. Acessar aplica√ß√£o
# Frontend: http://seu-servidor:3000
```

### Deploy com Nginx Reverse Proxy

```nginx
# /etc/nginx/sites-available/team-report
server {
    listen 80;
    server_name team-report.exemplo.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    location /api {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
}
```

### Deploy com SSL (Let's Encrypt)

```bash
# Instalar certbot
sudo apt install certbot python3-certbot-nginx

# Obter certificado
sudo certbot --nginx -d team-report.exemplo.com
```

## üìä Monitoramento

### Docker Stats

```bash
# Ver uso de recursos em tempo real
docker stats
```

### Logs Centralizados

```bash
# Exportar logs para arquivo
docker-compose logs > logs.txt

# Ver √∫ltimas 100 linhas
docker-compose logs --tail=100

# Seguir logs em tempo real
docker-compose logs -f
```

### Health Checks

```bash
# Frontend
curl http://localhost:3000/health

# Backend
curl http://localhost:5000/api/dashboard

# PostgreSQL
docker-compose exec postgres pg_isready -U teamreport
```

## üìö Refer√™ncias

- [Docker Documentation](https://docs.docker.com/)
- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [PostgreSQL Docker](https://hub.docker.com/_/postgres)
- [Node.js Docker Best Practices](https://github.com/nodejs/docker-node/blob/main/docs/BestPractices.md)
- [Nginx Docker](https://hub.docker.com/_/nginx)

---

**D√∫vidas?** Abra uma issue ou consulte a [documenta√ß√£o principal](./README.md).
